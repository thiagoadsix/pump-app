name: EAS Build

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üèó Setup repo
        uses: actions/checkout@v3

      - name: üèó Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: üèó Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üî® Generate app.json
        run: |
          cat <<EOT > app.json
          {
            "expo": {
              "extra": {
                "adMobAndroidApiId": "${{ secrets.AD_MOB_ANDROID_API_ID }}",
                "adMobBannerId": "${{ secrets.AD_MOB_BANNER_ID }}",
                "adMobInterstitialId": "${{ secrets.AD_MOB_INTERSTITIAL_ID }}",
                "eas": {
                  "projectId": "${{ secrets.EXPO_EAS_PROJECT_ID }}"
                }
              },
              "name": "pump",
              "slug": "pump",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#ffffff"
              },
              "updates": {
                "fallbackToCacheTimeout": 0,
                "enabled": true
              },
              "assetBundlePatterns": [
                "**/*"
              ],
              "ios": {
                "supportsTablet": true,
                "bundleIdentifier": "com.mobile.pump"
              },
              "android": {
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#FFFFFF"
                },
                "package": "com.mobile.pump"
              },
              "web": {
                "favicon": "./assets/favicon.png"
              },
              "plugins": [
                [
                  "expo-build-properties",
                  {
                    "ios": {
                      "useFrameworks": "static"
                    }
                  }
                ]
              ],
              "owner": "pump-app"
            },
            "react-native-google-mobile-ads": {
              "android_app_id": "${{ secrets.AD_MOB_ANDROID_API_ID }}"
            }
          }
          EOT

      - name: üî® Build on EAS
        run: eas build --platform android
        env:
          AD_MOB_ANDROID_API_ID: ${{ secrets.AD_MOB_ANDROID_API_ID }}
          AD_MOB_BANNER_ID: ${{ secrets.AD_MOB_BANNER_ID }}
          AD_MOB_INTERSTITIAL_ID: ${{ secrets.AD_MOB_INTERSTITIAL_ID }}
          EXPO_EAS_PROJECT_ID: ${{ secrets.EXPO_EAS_PROJECT_ID }}